name: Build APK with Buildozer

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    name: Build APK for Android
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: x64
      
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Set JAVA_HOME environment variable
        run: echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
        shell: bash
      
      - name: Prepare virtual environment
        run: |
          python3 -m venv venv
          source venv/bin/activate
          echo "Using Python==$(python --version)"
        shell: bash
      
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git \
            zip \
            unzip \
            openjdk-17-jdk \
            python3-pip \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo5 \
            cmake \
            libffi-dev \
            libssl-dev \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            libgstreamer1.0-0 \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good
      
      - name: Install Python build tools
        run: |
          export PATH=$PATH:~/.local/bin/
          python3 -m pip install --upgrade \
            Cython==0.29.33 \
            buildozer
      
      - name: Install app requirements
        working-directory: ./android_app
        run: |
          if [ -f requirements.txt ]; then
            python3 -m pip install -r requirements.txt
          fi
      
      - name: Build APK with Buildozer
        working-directory: ./android_app
        run: |
          echo "ðŸ”¨ Starting APK build with Buildozer..."
          buildozer -v android debug 2>&1 | tee build.log
          
          BUILD_STATUS=${PIPESTATUS[0]}
          
          if [ $BUILD_STATUS -eq 0 ]; then
            echo "âœ… Build completed successfully"
          else
            echo "âš ï¸ Build failed with status: $BUILD_STATUS"
            echo ""
            echo "Last 100 lines of build log:"
            tail -100 build.log || cat build.log
            exit $BUILD_STATUS
          fi
      
      - name: Verify APK exists
        working-directory: ./android_app
        run: |
          echo "ðŸ” Searching for APK files..."
          if [ -d "bin" ]; then
            ls -lh bin/ || echo "bin directory is empty"
            find bin -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
          else
            echo "bin directory does not exist"
            exit 1
          fi
      
      - name: Upload APK artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pdfsplitter-apk
          path: android_app/bin/*.apk
          retention-days: 90
          if-no-files-found: warn
      
      - name: Build Summary
        if: always()
        run: |
          echo "## ðŸ“± APK Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build ID | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download APK from Artifacts tab** (90-day retention)"
